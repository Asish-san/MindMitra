<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MindMitra ‚Äî private, multilingual companion</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f7f9fc}
    header{background:#6c5ce7;color:#fff;padding:14px}
    .wrap{max-width:860px;margin:22px auto;padding:12px}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 4px 18px rgba(0,0,0,0.06)}
    textarea{width:100%;min-height:90px;padding:10px;border-radius:8px;border:1px solid #e8eef7}
    button{background:#6c5ce7;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .msg{padding:10px;border-radius:12px;margin:8px 0;max-width:80%}
    .me{background:#e8f0ff;margin-left:auto}
    .bot{background:#f3f6ff}
    small{color:#475569}
  </style>
</head>
<body>
  <header><div class="wrap"><strong>MindMitra</strong> ‚Äî private, multilingual companion</div></header>
  <main class="wrap">
    <div class="card">
      <div class="row">
        <label for="lang">Reply language:</label>
        <select id="lang">
          <option value="">Auto</option>
          <option value="en">English</option>
          <option value="hi">Hindi</option>
          <option value="es">Spanish</option>
          <option value="bn">Bengali</option>
          <option value="ta">Tamil</option>
          <option value="te">Telugu</option>
          <option value="mr">Marathi</option>
          <option value="gu">Gujarati</option>
          <option value="kn">Kannada</option>
          <option value="ml">Malayalam</option>
          <option value="pa">Punjabi</option>
          <option value="or">Odia</option>
        </select>
        <button id="mic">üéôÔ∏è Voice</button>
        <button id="speak">üîä Speak Reply</button>
      </div>

      <div id="chat" style="max-height:40vh;overflow:auto;margin-bottom:10px"></div>

      <textarea id="input" placeholder="Type how you feel... (any supported language)"></textarea>
      <div class="row">
        <button id="send">Send</button>
        <div style="flex:1"><small>MindMitra is not a medical service. If you are in danger, call local emergency services.</small></div>
      </div>
    </div>
  </main>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const lang = document.getElementById('lang');
    const send = document.getElementById('send');
    const mic = document.getElementById('mic');
    const speakBtn = document.getElementById('speak');

    function addBubble(text, who='bot') {
      const el = document.createElement('div');
      el.className = 'msg ' + (who === 'me' ? 'me' : 'bot');
      el.textContent = text;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    async function postMessage(msg, langChoice) {
      addBubble(msg, 'me');
      input.value = '';
      send.disabled = true;
      try {
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, lang: langChoice || '' })
        });
        const j = await r.json();
        if (j.error) {
          addBubble('Sorry ‚Äî error: ' + j.error);
          console.error('Server returned error', j);
          return;
        }
        if (j.reply) {
          addBubble(j.reply);
          window.latestReply = j.reply;
          window.latestReplyLang = j.reply_lang || 'en';
        } else {
          addBubble('No reply received from server.');
        }
      } catch (e) {
        console.error('Network/server error', e);
        addBubble('Sorry ‚Äî server error. Try again in a moment.');
      } finally {
        send.disabled = false;
      }
    }

    send.addEventListener('click', () => {
      const txt = input.value.trim();
      if (!txt) return;
      postMessage(txt, lang.value);
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) send.click();
    });

    // Web Speech API
    let recognition = null;
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.onresult = (ev) => {
        const t = ev.results[0][0].transcript;
        input.value = input.value ? input.value + ' ' + t : t;
      };
      recognition.onerror = (e) => console.warn('Speech error', e);
    } else {
      mic.disabled = true;
      mic.title = 'Voice not supported';
    }

    mic.addEventListener('click', () => {
      if (!recognition) return;
      if (mic.dataset.listening === '1') {
        recognition.stop();
        mic.dataset.listening = '0';
        mic.textContent = 'üéôÔ∏è Voice';
      } else {
        recognition.start();
        mic.dataset.listening = '1';
        mic.textContent = '‚èπÔ∏è Stop';
      }
    });

    // SpeechSynthesis
    function speak(text, langCode) {
      if (!('speechSynthesis' in window)) {
        alert('Speech not supported in this browser.');
        return;
      }
      const ut = new SpeechSynthesisUtterance(text);
      if (langCode) ut.lang = langCode;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(ut);
    }

    speakBtn.addEventListener('click', () => {
      if (window.latestReply) {
        speak(window.latestReply, window.latestReplyLang || 'en-US');
      } else {
        alert('No reply yet.');
      }
    });

    addBubble('Hi ‚Äî I am MindMitra. Type or speak how you are feeling. I will listen and offer gentle support.');
  </script>
</body>
</html>
